% Compute F' via
% F' = F_x_components*x+F_u_components*u+b_components.
% Output is [F_x_components, F_u_components, F_b_components]

function [F_x_components, F_u_components, F_b_components, Z] = ...
    get_F_components(H11, H22, H12, H21, h, G1, G2,...
    theta1, theta2_unshift, r1, r2, theta_dot1, theta_dot2,...
    A_1, B1_1, B1_2, B1_3, B1_4, s1, s2,m_L1,m_L2)
   
        % Initially,
        % ZF' = A_star*x+B_star*u+C_star
        % Then left multiply by Z^{-1} on both sides to obtain 
        % F_x_components, F_u_components, and F_b_components
        Z = [1-(H11/(r1^2)-m_L1)*s1*B1_3, -H12/(r1*r2)*s2*B1_4;...
             -H21/(r1*r2)*s1*B1_3,    1-(H22/(r2^2)-m_L2)*s2*B1_4];

        [F_x_components] = Z\[((H11/r1^2-m_L1)*s1*A_1)+H12/(r1*r2)*s2*A_1;...
                              (H22/r2^2-m_L2)*s2*A_1+H21/(r1*r2)*s1*A_1];
        [F_u_components] = Z\[(H11/r1^2-m_L1)*s1*B1_1,H12/(r1*r2)*s2*B1_2;...
                               H21/(r1*r2)*s1*B1_1, ((H22/r2^2-m_L2)*s2*B1_2)];

        b_component1 = (-(H11*theta_dot1^2)/(r1^2)*get_dr_dtheta1(theta1)...
                -(H12*theta_dot2^2)/(r1*r2)*get_dr_dtheta2(theta2_unshift)...
                -(h*theta_dot2^2)/r1- 2*h*theta_dot1*theta_dot2/r1...
                +G1/r1);
        b_component2 = (-(H22*theta_dot2^2)/(r2^2)*get_dr_dtheta2(theta2_unshift)...
                -(H21*theta_dot1^2)/(r1*r2)*get_dr_dtheta1(theta1)... 
                +(h*theta_dot1^2)/r2+G2/r2);
        [F_b_components] = Z\[b_component1;b_component2];

end 